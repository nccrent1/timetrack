<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TimeTrack Cloud</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary: #6366f1; --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --gray: #64748b; --dark: #1e293b; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: var(--dark); }
        .container { max-width: 100%; padding: 10px; }
        .app-container { background: white; border-radius: 20px; min-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .header { background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 1.6rem; margin-bottom: 5px; }
        .content { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; }
        button { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 10px; transition: all 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-secondary { background: #f1f5f9; color: var(--dark); border: 2px solid #e2e8f0; }
        .hidden { display: none !important; }
        .nav-tabs { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 15px; padding: 5px; background: #f1f5f9; border-radius: 12px; }
        .nav-tab { flex: 1; padding: 10px 5px; background: transparent; border: none; border-radius: 8px; color: var(--gray); font-weight: 600; font-size: 0.7rem; text-align: center; line-height: 1.2; }
        .nav-tab.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: #f8fafc; border-radius: 16px; padding: 20px; margin-bottom: 15px; }
        .card-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-number { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.7rem; color: var(--gray); margin-top: 4px; }
        .entry-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .badge-work { background: #dbeafe; color: #1e40af; }
        .badge-holiday { background: #fce7f3; color: #be185d; }
        .badge-rest { background: #d1fae5; color: #065f46; }
        .badge-festive { background: #fef3c7; color: #92400e; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .alert { padding: 15px; border-radius: 12px; margin-bottom: 15px; font-size: 0.9rem; }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        .creds-box { background: #ecfdf5; border: 2px solid var(--success); border-radius: 12px; padding: 15px; margin-top: 15px; }
        .creds-box p { font-family: monospace; font-size: 0.9rem; margin: 8px 0; word-break: break-all; }
        .section-title { font-size: 0.8rem; color: var(--gray); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray); }
    </style>
</head>
<body>
    <div id="loginScreen" class="container">
        <div class="app-container">
            <div class="header">
                <h1>‚è∞ TimeTrack Cloud</h1>
                <p>Gestione Presenze Dipendenti</p>
            </div>
            <div class="content">
                <div id="loginAlert"></div>
                <div class="form-group">
                    <label>üìß Email</label>
                    <input type="email" id="loginEmail" placeholder="email@esempio.it">
                </div>
                <div class="form-group">
                    <label>üîë Password</label>
                    <input type="password" id="loginPassword" placeholder="password">
                </div>
                <button class="btn-primary" onclick="login()">Accedi</button>
            </div>
        </div>
    </div>

    <div id="appContainer" class="container hidden">
        <div class="app-container">
            <div class="header">
                <h1>TimeTrack</h1>
                <p id="welcomeText"></p>
            </div>
            <div class="content">
                <div id="adminNav" class="nav-tabs hidden">
                    <button class="nav-tab active" onclick="showTab('dashboard')">üìä<br>Dash</button>
                    <button class="nav-tab" onclick="showTab('team')">üë•<br>Team</button>
                    <button class="nav-tab" onclick="showTab('reports')">üìà<br>Report</button>
                </div>
                <div id="employeeNav" class="nav-tabs hidden">
                    <button class="nav-tab active" onclick="showTab('clock')">‚è∞<br>Timbra</button>
                    <button class="nav-tab" onclick="showTab('history')">üìã<br>Storico</button>
                </div>

                <div id="dashboard" class="tab-content active">
                    <div class="stat-grid">
                        <div class="stat-box"><div class="stat-number" id="statToday">-</div><div class="stat-label">Oggi</div></div>
                        <div class="stat-box"><div class="stat-number" id="statMonth">-</div><div class="stat-label">Ore Mese</div></div>
                        <div class="stat-box"><div class="stat-number" id="statTotal">-</div><div class="stat-label">Totali</div></div>
                    </div>
                    <div class="card">
                        <div class="card-title">üïê Registrazioni Oggi</div>
                        <div id="todayList"><div class="loading"></div></div>
                    </div>
                    <button class="btn-danger" onclick="logout()">Logout</button>
                </div>

                <div id="team" class="tab-content">
                    <div class="card">
                        <div class="card-title">‚ûï Nuovo Dipendente</div>
                        <div id="addAlert"></div>
                        <div class="form-group"><label>Nome Completo</label><input type="text" id="newName" placeholder="Mario Rossi"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="newEmail" placeholder="mario@email.it"></div>
                        <button class="btn-success" onclick="addEmployee()">Crea Dipendente</button>
                        <div id="newCreds" class="creds-box hidden">
                            <p style="font-weight: 600; margin-bottom: 10px;">‚úÖ Dipendente Creato!</p>
                            <div class="section-title">Link App</div>
                            <p id="appUrl"></p>
                            <div class="section-title">Credenziali</div>
                            <p>Email: <span id="credEmail"></span></p>
                            <p>Pass: <span id="credPass"></span></p>
                            <button class="btn-primary" onclick="shareWhatsApp()" style="margin-top: 10px;">üì± Condividi su WhatsApp</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-title">üë• Team</div>
                        <div id="teamList"><div class="loading"></div></div>
                    </div>
                </div>

                <div id="reports" class="tab-content">
                    <div class="card">
                        <div class="card-title">üìà Report Mensile</div>
                        <div class="form-group"><label>Mese</label><input type="month" id="reportMonth"></div>
                        <button class="btn-primary" onclick="loadReport()">Carica Report</button>
                        <button class="btn-secondary" onclick="exportExcel()">üìä Scarica Excel</button>
                        <div id="reportResult"></div>
                    </div>
                </div>

                <div id="clock" class="tab-content">
                    <div class="card" style="text-align: center; padding: 30px;">
                        <div id="currentDate" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 25px;"></div>
                        <div class="form-group" style="text-align: left;">
                            <label>Tipo Presenza</label>
                            <select id="clockType" onchange="toggleClockTime()" style="font-size: 1.1rem;">
                                <option value="work">üíº Lavoro</option>
                                <option value="holiday">üèñÔ∏è Ferie</option>
                                <option value="rest">üò¥ Riposo</option>
                                <option value="festive">üéâ Festivo</option>
                            </select>
                        </div>
                        <div id="clockTimeSection">
                            <div class="form-group" style="text-align: left;"><label>Ora Inizio</label><input type="time" id="clockStart" value="09:00" style="font-size: 1.3rem; text-align: center;"></div>
                            <div class="form-group" style="text-align: left;"><label>Ora Fine</label><input type="time" id="clockEnd" value="18:00" style="font-size: 1.3rem; text-align: center;"></div>
                        </div>
                        <button class="btn-success" onclick="saveClock()" id="saveBtn" style="font-size: 1.2rem; padding: 20px; margin-top: 10px;">üíæ Salva Registrazione</button>
                    </div>
                    <button class="btn-danger" onclick="logout()">Logout</button>
                </div>

                <div id="history" class="tab-content">
                    <div class="card">
                        <div class="card-title">üìã Le Mie Presenze</div>
                        <div class="form-group"><label>Seleziona Mese</label><input type="month" id="historyMonth" onchange="loadHistory()"></div>
                        <div id="historyList"><div class="loading"></div></div>
                        <div style="background: var(--primary); color: white; padding: 20px; border-radius: 12px; margin-top: 20px; text-align: center;">
                            <div style="font-size: 0.9rem; opacity: 0.9;">Totale Ore Mese</div>
                            <div style="font-size: 2.2rem; font-weight: 700;" id="historyTotal">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzCHH0x-8Gw1YNOoBqJ_rZH74PYBAfKUeczK8H1SXYXCSvhRCVSMHa6_coHPhypUArR/exec';
        const APP_URL = window.location.href.split('?')[0];
        let currentUser = null;
        let allEntries = [];
        let allUsers = [];
        let lastCreated = null;

        window.onload = function() {
            const today = new Date();
            document.getElementById('currentDate').textContent = today.toLocaleDateString('it-IT', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
            const monthStr = today.toISOString().slice(0, 7);
            document.getElementById('reportMonth').value = monthStr;
            document.getElementById('historyMonth').value = monthStr;
        };

        async function apiCall(action, params = {}) {
            try {
                const url = new URL(API_URL);
                url.searchParams.append('action', action);
                Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                const response = await fetch(url);
                return await response.json();
            } catch (e) {
                console.error('Errore API:', e);
                return { success: false, error: 'Errore di connessione' };
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) {
                showAlert('loginAlert', 'Inserisci email e password', 'error');
                return;
            }
            const result = await apiCall('login', { email, password });
            if (result.success) {
                currentUser = result.user;
                showApp();
            } else {
                showAlert('loginAlert', 'Credenziali errate', 'error');
            }
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            document.getElementById('welcomeText').textContent = currentUser.nome + ' ‚Ä¢ ' + (currentUser.ruolo === 'admin' ? 'Admin' : 'Dipendente');
            if (currentUser.ruolo === 'admin') {
                document.getElementById('adminNav').classList.remove('hidden');
                document.getElementById('employeeNav').classList.add('hidden');
                loadDashboard();
                loadTeam();
            } else {
                document.getElementById('adminNav').classList.add('hidden');
                document.getElementById('employeeNav').classList.remove('hidden');
                showTab('clock');
            }
        }

        function logout() {
            currentUser = null;
            location.reload();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'team') loadTeam();
            if (tabName === 'history') loadHistory();
        }

        async function loadDashboard() {
            const result = await apiCall('get');
            if (!result.success) return;
            allEntries = result.data;
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = allEntries.filter(e => e.data === today);
            const month = new Date().toISOString().slice(0, 7);
            const monthEntries = allEntries.filter(e => e.data && e.data.startsWith(month) && e.tipo === 'work');
            const hours = monthEntries.reduce((sum, e) => sum + (parseFloat(e.ore) || 0), 0);
            document.getElementById('statToday').textContent = todayEntries.length;
            document.getElementById('statMonth').textContent = hours.toFixed(0);
            document.getElementById('statTotal').textContent = allEntries.length;
            const list = document.getElementById('todayList');
            if (todayEntries.length === 0) {
                list.innerHTML = '<div class="empty-state">Nessuna registrazione oggi</div>';
            } else {
                list.innerHTML = todayEntries.map(e => `
                    <div class="entry-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${e.nome}</strong>
                            <span class="badge badge-${e.tipo}">${label(e.tipo)}</span>
                        </div>
                        ${e.tipo === 'work' ? `<div style="color: var(--gray); font-size: 0.9rem; margin-top: 5px;">${e.inizio}-${e.fine} ‚Ä¢ ${e.ore}h</div>` : ''}
                    </div>
                `).join('');
            }
        }

        async function loadTeam() {
            const result = await apiCall('get_users');
            if (!result.success) return;
            allUsers = result.users;
            const employees = allUsers.filter(u => u.ruolo === 'dipendente');
            const list = document.getElementById('teamList');
            if (employees.length === 0) {
                list.innerHTML = '<div class="empty-state">Nessun dipendente. Aggiungine uno sopra!</div>';
            } else {
                list.innerHTML = employees.map(u => `
                    <div class="entry-item">
                        <div>
                            <div style="font-weight: 600;">${u.nome}</div>
                            <div style="font-size: 0.85rem; color: var(--gray);">${u.email}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function addEmployee() {
            const name = document.getElementById('newName').value;
            const email = document.getElementById('newEmail').value;
            if (!name || !email) {
                showAlert('addAlert', 'Inserisci nome e email', 'error');
                return;
            }
            const password = Math.random().toString(36).substring(2, 10);
            const result = await apiCall('add_user', { nome: name, email: email, password: password });
            if (result.success) {
                lastCreated = result.user;
                document.getElementById('newName').value = '';
                document.getElementById('newEmail').value = '';
                document.getElementById('appUrl').textContent = APP_URL;
                document.getElementById('credEmail').textContent = lastCreated.email;
                document.getElementById('credPass').textContent = lastCreated.password;
                document.getElementById('newCreds').classList.remove('hidden');
                loadTeam();
            } else {
                showAlert('addAlert', 'Errore creazione dipendente', 'error');
            }
        }

        function shareWhatsApp() {
            const text = `Ciao ${lastCreated.nome}!\n\nEcco l'app per registrare le tue ore:\n${APP_URL}\n\nüìß Email: ${lastCreated.email}\nüîë Password: ${lastCreated.password}\n\nEntra e inizia a timbrare!`;
            window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
        }

        function toggleClockTime() {
            const type = document.getElementById('clockType').value;
            document.getElementById('clockTimeSection').style.display = type === 'work' ? 'block' : 'none';
        }

        async function saveClock() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Salvataggio...';
            const type = document.getElementById('clockType').value;
            const date = new Date().toISOString().split('T')[0];
            let inizio = '', fine = '';
            if (type === 'work') {
                inizio = document.getElementById('clockStart').value;
                fine = document.getElementById('clockEnd').value;
                if (!inizio || !fine) {
                    btn.innerHTML = originalText;
                    alert('Inserisci orari di inizio e fine');
                    return;
                }
            }
            const result = await apiCall('save', {
                userId: currentUser.id,
                nome: currentUser.nome,
                data: date,
                tipo: type,
                inizio: inizio,
                fine: fine
            });
            if (result.success) {
                btn.innerHTML = '‚úÖ Salvato!';
                btn.style.background = '#10b981';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            } else {
                btn.innerHTML = '‚ùå Errore';
                setTimeout(() => btn.innerHTML = originalText, 2000);
            }
        }

        async function loadHistory() {
            const result = await apiCall('get');
            if (!result.success) return;
            const month = document.getElementById('historyMonth').value;
            const myEntries = result.data.filter(e => e.userId == currentUser.id && e.data && e.data.startsWith(month)).sort((a, b) => b.data.localeCompare(a.data));
            const list = document.getElementById('historyList');
            if (myEntries.length === 0) {
                list.innerHTML = '<div class="empty-state">Nessuna registrazione questo mese</div>';
            } else {
                list.innerHTML = myEntries.map(e => `
                    <div class="entry-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500;">${formatDate(e.data)}</span>
                            <span class="badge badge-${e.tipo}">${label(e.tipo)}</span>
                        </div>
                        ${e.tipo === 'work' ? `<div style="color: var(--gray); font-size: 0.9rem; margin-top: 5px;">${e.ore} ore</div>` : ''}
                    </div>
                `).join('');
            }
            const total = myEntries.filter(e => e.tipo === 'work').reduce((sum, e) => sum + (parseFloat(e.ore) || 0), 0);
            document.getElementById('historyTotal').textContent = total.toFixed(1);
        }

        async function loadReport() {
            const result = await apiCall('get');
            if (!result.success) return;
            const month = document.getElementById('reportMonth').value;
            const entries = result.data.filter(e => e.data && e.data.startsWith(month));
            const workEntries = entries.filter(e => e.tipo === 'work');
            const totalHours = workEntries.reduce((sum, e) => sum + (parseFloat(e.ore) || 0), 0);
            const div = document.getElementById('reportResult');
            div.innerHTML = `
                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px;">Report ${month}</h3>
                    <div class="stat-grid">
                        <div class="stat-box"><div class="stat-number">${totalHours.toFixed(1)}</div><div class="stat-label">Ore Lavoro</div></div>
                        <div class="stat-box"><div class="stat-number">${entries.filter(e => e.tipo === 'holiday').length}</div><div class="stat-label">Ferie</div></div>
                        <div class="stat-box"><div class="stat-number">${entries.filter(e => e.tipo === 'rest').length}</div><div class="stat-label">Riposo</div></div>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                        ${entries.map(e => `
                            <div style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${e.nome}</span>
                                    <span class="badge badge-${e.tipo}">${label(e.tipo)}</span>
                                </div>
                                <div style="color: var(--gray); font-size: 0.85rem;">${formatDate(e.data)}${e.tipo === 'work' ? ' ‚Ä¢ ' + e.ore + 'h' : ''}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function exportExcel() {
            alert('Per scaricare Excel:\n1. Apri il foglio Google\n2. File ‚Üí Scarica ‚Üí Microsoft Excel (.xlsx)');
        }

        function label(type) {
            const labels = { work: 'Lavoro', holiday: 'Ferie', rest: 'Riposo', festive: 'Festivo' };
            return labels[type] || type;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        function showAlert(id, msg, type) {
            const el = document.getElementById(id);
            el.className = 'alert alert-' + type;
            el.textContent = msg;
            setTimeout(() => el.textContent = '', 3000);
        }
    </script>
</body>
</html>
